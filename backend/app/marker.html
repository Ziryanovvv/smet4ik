<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smet4ik AI Trainer - –†–∞–∑–º–µ—Ç–∫–∞ —á–µ—Ä—Ç–µ–∂–µ–π —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∑—É–º–æ–º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 40px;
            border-bottom: 3px solid rgba(255,255,255,0.2);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 i {
            font-size: 32px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .workspace {
            display: flex;
            min-height: 850px;
        }
        
        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —á–µ—Ä—Ç–µ–∂ */
        .drawing-panel {
            flex: 4;
            background: #1a1a2e;
            position: relative;
            overflow: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .drawing-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: auto;
            border-radius: 10px;
            background: #2d2d44;
        }
        
        .drawing-controls {
            width: 100%;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
        }
        
        .control-group label {
            color: white;
            font-weight: 500;
            font-size: 14px;
        }
        
        .control-group input, .control-group select {
            background: rgba(255,255,255,0.95);
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .control-group button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 5px;
        }
        
        .control-group button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        #drawingCanvas {
            display: block;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: crosshair;
            transform-origin: 0 0;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #45a049;
            transform: scale(1.1);
        }
        
        .zoom-display {
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-family: monospace;
        }
        
        .coordinates-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            z-index: 100;
        }
        
        .pan-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }
        
        /* –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        .calibration-panel {
            width: 100%;
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #FFC107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .calibration-panel h4 {
            color: #FFC107;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .calibration-steps {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .calibration-step {
            flex: 1;
            min-width: 200px;
        }
        
        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã */
        .tools-panel {
            flex: 1.5;
            background: #f8f9fa;
            padding: 25px;
            border-left: 3px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .section h3 i {
            color: #667eea;
        }
        
        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tool-btn {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .tool-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .tool-btn.active {
            border-color: #4CAF50;
            background: #f0f9f0;
        }
        
        .tool-btn i {
            font-size: 18px;
        }
        
        .wall-btn i { color: #FF5722; }
        .window-btn i { color: #2196F3; }
        .door-btn i { color: #795548; }
        .measure-btn i { color: #9C27B0; }
        
        .objects-list {
            max-height: 250px;
            overflow-y: auto;
            font-size: 13px;
        }
        
        .object-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 6px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .object-item.wall { border-left-color: #FF5722; }
        .object-item.window { border-left-color: #2196F3; }
        .object-item.door { border-left-color: #795548; }
        
        .object-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background: #cc0000;
        }
        
        .scale-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .stat-card .label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .calibrate-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }
        
        .calibrate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #FF5722 0%, #D84315 100%);
            color: white;
        }
        
        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.4);
        }
        
        .status-bar {
            background: #333;
            color: white;
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        #statusMessage {
            font-size: 13px;
        }
        
        .instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .hotkeys {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .hotkeys h4 {
            margin-bottom: 8px;
            color: #2E7D32;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-ruler-combined"></i>
                Smet4ik AI Trainer - –†–∞–∑–º–µ—Ç–∫–∞ —á–µ—Ä—Ç–µ–∂–µ–π —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∑—É–º–æ–º
            </h1>
            <p>–¢–µ–ø–µ—Ä—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞ –∏ —Ä–∞–∑–º–µ—Ç–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ª—é–±–æ–º –∑—É–º–µ!</p>
        </div>
        
        <div class="instructions">
            <strong>üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑—É–º:</strong>
            <ol>
                <li>–ö–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ/—É–º–µ–Ω—å—à–µ–Ω–∏–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!)</li>
                <li>–ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ + –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ —á–µ—Ä—Ç–µ–∂—É</li>
                <li>–ö–Ω–æ–ø–∫–∏ + –∏ - –Ω–∞ –ø–∞–Ω–µ–ª–∏ - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞</li>
                <li>–ö–Ω–æ–ø–∫–∞ "–î–æ–º–æ–π" - —Å–±—Ä–æ—Å –∑—É–º–∞ –∏ –ø–æ–∑–∏—Ü–∏–∏</li>
                <li>–ö–Ω–æ–ø–∫–∞ "–í–º–µ—Å—Ç–∏—Ç—å" - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
            </ol>
            <p style="color: green; margin-top: 10px; font-weight: bold;">
                ‚úì –¢–µ–ø–µ—Ä—å —Ç–æ—á–∫–∏ —Ä–∞–∑–º–µ—Ç–∫–∏ —Å—Ç–∞–≤—è—Ç—Å—è —Ç–æ—á–Ω–æ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –ø—Ä–∏ –ª—é–±–æ–º —É—Ä–æ–≤–Ω–µ –∑—É–º–∞!
            </p>
        </div>
        
        <div class="hotkeys">
            <h4>üìã –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</h4>
            <div>W - –°—Ç–µ–Ω–∞ | O - –û–∫–Ω–æ | D - –î–≤–µ—Ä—å | M - –ò–∑–º–µ—Ä–∏—Ç—å | +/- - –ó—É–º | –ü—Ä–∞–≤.–∫–Ω–æ–ø–∫–∞ - –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ | Home - –°–±—Ä–æ—Å</div>
        </div>
        
        <div class="workspace">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —á–µ—Ä—Ç–µ–∂ -->
            <div class="drawing-panel">
                <div class="drawing-controls">
                    <div class="control-group">
                        <label><i class="fas fa-project-diagram"></i> Project ID:</label>
                        <input type="text" id="projectId" value="1856415c">
                    </div>
                    
                    <div class="control-group">
                        <label><i class="fas fa-file-alt"></i> –°—Ç—Ä–∞–Ω–∏—Ü–∞:</label>
                        <input type="number" id="pageNum" value="1" min="1">
                    </div>
                    
                    <div class="control-group">
                        <button onclick="loadFloorPlan()">
                            <i class="fas fa-sync-alt"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä—Ç–µ–∂
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <label><i class="fas fa-ruler"></i> –¢–µ–∫—É—â–∏–π –º–∞—Å—à—Ç–∞–±:</label>
                        <input type="text" id="currentScale" value="–ù–µ –∑–∞–¥–∞–Ω" readonly style="background: #e0e0e0;">
                    </div>
                    
                    <div class="control-group">
                        <button onclick="toggleCalibration()" class="calibrate-btn">
                            <i class="fas fa-ruler-combined"></i> –ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±
                        </button>
                    </div>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ -->
                <div class="calibration-panel" id="calibrationPanel">
                    <h4><i class="fas fa-sliders-h"></i> –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –º–∞—Å—à—Ç–∞–±–∞</h4>
                    <div class="calibration-steps">
                        <div class="calibration-step">
                            <label>1. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–∞—á–∞–ª–æ –æ—Ç—Ä–µ–∑–∫–∞ —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º</label>
                            <input type="text" id="calPoint1" value="–ù–µ –≤—ã–±—Ä–∞–Ω–∞" readonly style="background: #fff3cd;">
                        </div>
                        <div class="calibration-step">
                            <label>2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–æ–Ω–µ—Ü –æ—Ç—Ä–µ–∑–∫–∞</label>
                            <input type="text" id="calPoint2" value="–ù–µ –≤—ã–±—Ä–∞–Ω–∞" readonly style="background: #fff3cd;">
                        </div>
                        <div class="calibration-step">
                            <label>3. –í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É (–º–µ—Ç—Ä—ã)</label>
                            <input type="number" id="realLength" step="0.01" min="0.1" max="100" value="3.5" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 3.5">
                            <button onclick="applyCalibration()"><i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É</button>
                        </div>
                        <div class="calibration-step">
                            <label>4. –†–µ–∑—É–ª—å—Ç–∞—Ç</label>
                            <input type="text" id="calResult" value="–û–∂–∏–¥–∞–Ω–∏–µ..." readonly style="background: #e8f5e9;">
                            <button onclick="cancelCalibration()"><i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
                
                <div class="drawing-container" id="drawingContainer">
                    <canvas id="drawingCanvas"></canvas>
                    
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomOut()" title="–£–º–µ–Ω—å—à–∏—Ç—å (–ö–æ–ª–µ—Å–æ –≤–Ω–∏–∑)">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <div class="zoom-display" id="zoomDisplay">100%</div>
                        <button class="zoom-btn" onclick="zoomIn()" title="–£–≤–µ–ª–∏—á–∏—Ç—å (–ö–æ–ª–µ—Å–æ –≤–≤–µ—Ä—Ö)">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="zoom-btn" onclick="resetZoom()" title="–°–±—Ä–æ—Å–∏—Ç—å –∑—É–º (Home)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="zoom-btn" onclick="fitToScreen()" title="–í–º–µ—Å—Ç–∏—Ç—å –≤ —ç–∫—Ä–∞–Ω">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    
                    <div class="coordinates-display" id="coordinates">
                        –ü–∏–∫—Å–µ–ª–∏: (0, 0) | –ú–µ—Ç—Ä—ã: (0.00, 0.00) | –ó—É–º: 100%
                    </div>
                    
                    <div class="pan-hint" id="panHint">
                        ‚ö° –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –ø—Ä–∞–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
            <div class="tools-panel">
                <div class="section">
                    <h3><i class="fas fa-tools"></i> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
                    <div class="tool-buttons">
                        <div class="tool-btn wall-btn active" onclick="selectTool('wall')" title="–°—Ç–µ–Ω–∞ (W)">
                            <i class="fas fa-border-style"></i>
                            <span>–°—Ç–µ–Ω–∞</span>
                        </div>
                        <div class="tool-btn window-btn" onclick="selectTool('window')" title="–û–∫–Ω–æ (O)">
                            <i class="fas fa-square"></i>
                            <span>–û–∫–Ω–æ</span>
                        </div>
                        <div class="tool-btn door-btn" onclick="selectTool('door')" title="–î–≤–µ—Ä—å (D)">
                            <i class="fas fa-door-closed"></i>
                            <span>–î–≤–µ—Ä—å</span>
                        </div>
                        <div class="tool-btn measure-btn" onclick="selectTool('measure')" title="–ò–∑–º–µ—Ä–∏—Ç—å (M)">
                            <i class="fas fa-ruler"></i>
                            <span>–ò–∑–º–µ—Ä–∏—Ç—å</span>
                        </div>
                        <div class="tool-btn" onclick="selectTool('select')" title="–í—ã–±–æ—Ä">
                            <i class="fas fa-mouse-pointer"></i>
                            <span>–í—ã–±–æ—Ä</span>
                        </div>
                        <div class="tool-btn" onclick="toggleGrid()" title="–°–µ—Ç–∫–∞">
                            <i class="fas fa-th"></i>
                            <span>–°–µ—Ç–∫–∞</span>
                        </div>
                        <div class="tool-btn" onclick="testCoordinatesMode()" title="–¢–µ—Å—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç">
                            <i class="fas fa-crosshairs"></i>
                            <span>–¢–µ—Å—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button onclick="completeCurrentObject()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–±—ä–µ–∫—Ç (Enter)
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-ruler-horizontal"></i> –ú–∞—Å—à—Ç–∞–± –∏ –∑—É–º</h3>
                    <div class="scale-info">
                        <div><strong>–ú–∞—Å—à—Ç–∞–± —á–µ—Ä—Ç–µ–∂–∞:</strong> <span id="scaleRatio">1 –ø–∏–∫—Å–µ–ª—å = ? –º–µ—Ç—Ä–æ–≤</span></div>
                        <div><strong>–¢–µ–∫—É—â–∏–π –∑—É–º:</strong> <span id="currentZoom">100%</span></div>
                        <div><strong>–ü–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã:</strong> <span id="viewportPosition">X: 0, Y: 0</span></div>
                        <div style="margin-top: 10px;">
                            <button onclick="zoomIn()" style="padding: 5px 10px; margin-right: 5px;"><i class="fas fa-plus"></i></button>
                            <button onclick="zoomOut()" style="padding: 5px 10px; margin-right: 5px;"><i class="fas fa-minus"></i></button>
                            <button onclick="resetZoom()" style="padding: 5px 10px;"><i class="fas fa-sync-alt"></i> –°–±—Ä–æ—Å</button>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-layer-group"></i> –û–±—ä–µ–∫—Ç—ã</h3>
                    <div class="objects-list" id="objectsList">
                        <!-- –û–±—ä–µ–∫—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                        –í—Å–µ–≥–æ: <span id="totalObjects">0</span> –æ–±—ä–µ–∫—Ç–æ–≤
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≤ –º–µ—Ç—Ä–∞—Ö)</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="number" id="wallsCount">0</div>
                            <div class="label">–°—Ç–µ–Ω</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="windowsCount">0</div>
                            <div class="label">–û–∫–æ–Ω</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="doorsCount">0</div>
                            <div class="label">–î–≤–µ—Ä–µ–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="totalLength">0.0</div>
                            <div class="label">–ú–µ—Ç—Ä–æ–≤ —Å—Ç–µ–Ω</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-database"></i> –î–µ–π—Å—Ç–≤–∏—è</h3>
                    <div class="action-buttons">
                        <button class="action-btn save-btn" onclick="saveMarkup()">
                            <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É (–≤ –ë–î + —Ñ–∞–π–ª)
                        </button>
                        <button class="action-btn calibrate-btn" onclick="toggleCalibration()">
                            <i class="fas fa-ruler-combined"></i> –ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±
                        </button>
                        <button class="action-btn clear-btn" onclick="clearAll()">
                            <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                        </button>
                        <button class="action-btn" onclick="exportToJSON()" style="background: #607d8b; color: white;">
                            <i class="fas fa-file-export"></i> –¢–æ–ª—å–∫–æ —ç–∫—Å–ø–æ—Ä—Ç –≤ JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div id="statusMessage">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä—Ç–µ–∂. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ –¥–ª—è –∑—É–º–∞.</div>
            <div>
                <span id="currentTool">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –°—Ç–µ–Ω–∞</span> | 
                <span id="pointsCount">–¢–æ—á–µ–∫: 0</span> |
                <span id="calibrationStatus">–ú–∞—Å—à—Ç–∞–±: –ù–µ –∑–∞–¥–∞–Ω</span>
            </div>
        </div>
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let canvas = document.getElementById('drawingCanvas');
        let ctx = canvas.getContext('2d');
        let container = document.getElementById('drawingContainer');
        let currentImage = null;
        
        // –°–∏—Å—Ç–µ–º–∞ –∑—É–º–∞ –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è
        let zoom = 1.0;
        let minZoom = 0.1;
        let maxZoom = 10.0;
        let offsetX = 0;
        let offsetY = 0;
        let isPanning = false;
        let panStartX = 0;
        let panStartY = 0;
        
        // –°–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ –º–∞—Å—à—Ç–∞–±–∞
        let scale = 1.0; // –ü–∏–∫—Å–µ–ª–∏ –∫ –º–µ—Ç—Ä–∞–º: 1 –ø–∏–∫—Å–µ–ª—å = scale –º–µ—Ç—Ä–æ–≤
        let calibrationPoints = [];
        let isCalibrating = false;
        let showGrid = true;
        let testMode = false;
        
        // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –æ–±—ä–µ–∫—Ç—ã
        let currentTool = 'wall';
        let currentPoints = [];
        let markedObjects = [];
        let measurements = [];
        let selectedObject = null;
        let lastX = 0;
        let lastY = 0;
        
        // ========== –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–û–û–†–î–ò–ù–ê–¢ ==========
        
        function getCanvasCoordinates(e) {
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas
            const rect = canvas.getBoundingClientRect();
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —á–µ—Ä—Ç–µ–∂–∞ —Å —É—á–µ—Ç–æ–º –∑—É–º–∞ –∏ —Å–º–µ—â–µ–Ω–∏—è
            const canvasX = (mouseX - offsetX) / zoom;
            const canvasY = (mouseY - offsetY) / zoom;
            
            return { 
                x: canvasX, 
                y: canvasY,
                screenX: mouseX,
                screenY: mouseY
            };
        }
        
        function getScreenCoordinates(canvasX, canvasY) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —á–µ—Ä—Ç–µ–∂–∞ –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            return {
                x: canvasX * zoom + offsetX,
                y: canvasY * zoom + offsetY
            };
        }
        
        // ========== –§–£–ù–ö–¶–ò–ò –ó–£–ú–ê –ò –ü–ê–ù–û–†–ê–ú–ò–†–û–í–ê–ù–ò–Ø ==========
        
        function applyTransform() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
            ctx.setTransform(zoom, 0, 0, zoom, offsetX, offsetY);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('zoomDisplay').textContent = `${Math.round(zoom * 100)}%`;
            document.getElementById('currentZoom').textContent = `${Math.round(zoom * 100)}%`;
            document.getElementById('viewportPosition').textContent = `X: ${Math.round(offsetX)}, Y: ${Math.round(offsetY)}`;
        }
        
        function zoomIn(factor = 1.2) {
            const oldZoom = zoom;
            const newZoom = Math.min(maxZoom, zoom * factor);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∑—É–º–∞
            const rect = container.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–º–µ—â–µ–Ω–∏–µ
            offsetX = centerX - (centerX - offsetX) * (newZoom / oldZoom);
            offsetY = centerY - (centerY - offsetY) * (newZoom / oldZoom);
            
            zoom = newZoom;
            applyTransform();
            draw();
            showStatus(`–£–≤–µ–ª–∏—á–µ–Ω–∏–µ: ${Math.round(zoom * 100)}%`, 'info');
        }
        
        function zoomOut(factor = 1.2) {
            const oldZoom = zoom;
            const newZoom = Math.max(minZoom, zoom / factor);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∑—É–º–∞
            const rect = container.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–º–µ—â–µ–Ω–∏–µ
            offsetX = centerX - (centerX - offsetX) * (newZoom / oldZoom);
            offsetY = centerY - (centerY - offsetY) * (newZoom / oldZoom);
            
            zoom = newZoom;
            applyTransform();
            draw();
            showStatus(`–£–º–µ–Ω—å—à–µ–Ω–∏–µ: ${Math.round(zoom * 100)}%`, 'info');
        }
        
        function resetZoom() {
            zoom = 1.0;
            offsetX = 0;
            offsetY = 0;
            applyTransform();
            draw();
            showStatus('–ó—É–º —Å–±—Ä–æ—à–µ–Ω', 'info');
        }
        
        function fitToScreen() {
            if (!currentImage || !canvas.width || !canvas.height) return;
            
            const containerRect = container.getBoundingClientRect();
            const containerWidth = containerRect.width - 40;
            const containerHeight = containerRect.height - 40;
            
            const scaleX = containerWidth / canvas.width;
            const scaleY = containerHeight / canvas.height;
            const newZoom = Math.min(scaleX, scaleY) * 0.95; // 95% —á—Ç–æ–±—ã –±—ã–ª–∏ –æ—Ç—Å—Ç—É–ø—ã
            
            zoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
            offsetX = (containerWidth - canvas.width * zoom) / 2;
            offsetY = (containerHeight - canvas.height * zoom) / 2;
            
            applyTransform();
            draw();
            showStatus(`–í–º–µ—â–µ–Ω–æ –≤ —ç–∫—Ä–∞–Ω: ${Math.round(zoom * 100)}%`, 'info');
        }
        
        // ========== –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –ò –û–¢–†–ò–°–û–í–ö–ò ==========
        
        async function loadFloorPlan() {
            const projectId = document.getElementById('projectId').value;
            const pageNum = document.getElementById('pageNum').value;
            
            showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä—Ç–µ–∂–∞ –ø—Ä–æ–µ–∫—Ç–∞ ${projectId}, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNum}...`, 'info');
            
            try {
                const response = await fetch(`/project/${projectId}/page/${pageNum}/image`);
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                currentImage = new Image();
                currentImage.onload = function() {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas —Ä–∞–≤–Ω—ã–º —Ä–∞–∑–º–µ—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    canvas.width = currentImage.width;
                    canvas.height = currentImage.height;
                    
                    applyTransform();
                    draw();
                    showStatus(`–ß–µ—Ä—Ç–µ–∂ –∑–∞–≥—Ä—É–∂–µ–Ω: ${canvas.width}√ó${canvas.height} –ø–∏–∫—Å–µ–ª–µ–π`, 'success');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–º–µ—â–∞–µ–º –≤ —ç–∫—Ä–∞–Ω
                    setTimeout(fitToScreen, 100);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞
                    autoEstimateScale();
                };
                
                currentImage.onerror = function() {
                    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                };
                
                currentImage.src = url;
                
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        function draw() {
            // –û—á–∏—â–∞–µ–º canvas
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
            applyTransform();
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
            if (showGrid) {
                drawGrid();
            }
            
            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (currentImage) {
                ctx.drawImage(currentImage, 0, 0);
            } else {
                // –ó–∞–≥–ª—É—à–∫–∞
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä—Ç–µ–∂ –¥–ª—è —Ä–∞–∑–º–µ—Ç–∫–∏', canvas.width/2, canvas.height/2);
            }
            
            // –†–∏—Å—É–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ
            drawMeasurements();
            drawMarkedObjects();
            drawCurrentPoints();
            
            if (isCalibrating) {
                drawCalibrationPoints();
            }
        }
        
        function drawGrid() {
            const gridSize = 50; // –†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ —Å–µ—Ç–∫–∏
            
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 1 / zoom;
            
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ç–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä—É–ø–Ω–∞—è
            if (gridSize * zoom < 10) return;
            
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let y = 0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        function drawCalibrationPoints() {
            calibrationPoints.forEach((point, index) => {
                ctx.fillStyle = '#FF9800';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(index + 1, point.x - 4, point.y + 4);
                
                // –õ–∏–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
                if (calibrationPoints.length === 2) {
                    const p1 = calibrationPoints[0];
                    const p2 = calibrationPoints[1];
                    const dx = p2.x - p1.x;
                    const dy = p2.y - p1.y;
                    const length = Math.sqrt(dx*dx + dy*dy);
                    
                    ctx.strokeStyle = '#FF9800';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // –¢–µ–∫—Å—Ç —Å –¥–ª–∏–Ω–æ–π
                    const midX = (p1.x + p2.x) / 2;
                    const midY = (p1.y + p2.y) / 2;
                    
                    ctx.fillStyle = '#FF9800';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${length.toFixed(1)}px`, midX, midY - 10);
                    ctx.textAlign = 'left';
                }
            });
        }
        
        function drawMeasurements() {
            measurements.forEach(m => {
                ctx.strokeStyle = '#9C27B0';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(m.x1, m.y1);
                ctx.lineTo(m.x2, m.y2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // –¢–æ—á–∫–∏
                ctx.fillStyle = '#9C27B0';
                ctx.beginPath();
                ctx.arc(m.x1, m.y1, 5, 0, Math.PI * 2);
                ctx.arc(m.x2, m.y2, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // –¢–µ–∫—Å—Ç
                const midX = (m.x1 + m.x2) / 2;
                const midY = (m.y1 + m.y2) / 2;
                
                ctx.fillStyle = '#7B1FA2';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${m.lengthMeters.toFixed(2)} –º`, midX, midY - 10);
                ctx.textAlign = 'left';
            });
        }
        
        function drawMarkedObjects() {
            markedObjects.forEach((obj, index) => {
                let color, lineWidth;
                switch(obj.type) {
                    case 'wall':
                        color = '#FF5722';
                        lineWidth = 4;
                        break;
                    case 'window':
                        color = '#2196F3';
                        lineWidth = 3;
                        ctx.setLineDash([5, 5]);
                        break;
                    case 'door':
                        color = '#795548';
                        lineWidth = 3;
                        ctx.setLineDash([3, 3]);
                        break;
                    default:
                        color = '#666';
                        lineWidth = 2;
                }
                
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.fillStyle = color;
                
                // –õ–∏–Ω–∏–∏
                if (obj.points.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(obj.points[0].x, obj.points[0].y);
                    for (let i = 1; i < obj.points.length; i++) {
                        ctx.lineTo(obj.points[i].x, obj.points[i].y);
                    }
                    if (obj.type === 'wall' && obj.points.length > 2) {
                        ctx.closePath();
                    }
                    ctx.stroke();
                }
                
                ctx.setLineDash([]);
                
                // –¢–æ—á–∫–∏
                obj.points.forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 6, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // –†–∞–∑–º–µ—Ä—ã (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∑—É–º–µ)
                if (zoom > 0.5) {
                    for (let i = 0; i < obj.points.length - 1; i++) {
                        const p1 = obj.points[i];
                        const p2 = obj.points[i + 1];
                        const lengthPx = distance(p1, p2);
                        const lengthMeters = lengthPx * scale;
                        
                        if (lengthMeters > 0.1) {
                            const midX = (p1.x + p2.x) / 2;
                            const midY = (p1.y + p2.y) / 2;
                            
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                            ctx.fillRect(midX - 25, midY - 15, 50, 20);
                            
                            ctx.fillStyle = color;
                            ctx.font = 'bold 12px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(`${lengthMeters.toFixed(2)} –º`, midX, midY);
                            ctx.textAlign = 'left';
                        }
                    }
                }
            });
        }
        
        function drawCurrentPoints() {
            if (currentPoints.length === 0) return;
            
            let color;
            switch(currentTool) {
                case 'wall': color = '#FF5722'; break;
                case 'window': color = '#2196F3'; break;
                case 'door': color = '#795548'; break;
                case 'measure': color = '#9C27B0'; break;
                default: color = '#4CAF50';
            }
            
            // –õ–∏–Ω–∏–∏ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
            if (currentPoints.length > 1) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                
                ctx.beginPath();
                ctx.moveTo(currentPoints[0].x, currentPoints[0].y);
                for (let i = 1; i < currentPoints.length; i++) {
                    ctx.lineTo(currentPoints[i].x, currentPoints[i].y);
                }
                
                // –õ–∏–Ω–∏—è –∫ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏
                if (lastX !== undefined && lastY !== undefined) {
                    ctx.lineTo(lastX, lastY);
                }
                
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // –¢–æ—á–∫–∏
            currentPoints.forEach((point, index) => {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(point.x, point.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // –ù–æ–º–µ—Ä —Ç–æ—á–∫–∏
                if (zoom > 0.5) {
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(index + 1, point.x - 4, point.y + 4);
                }
            });
        }
        
        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ª–µ—Å–∏–∫–∞ –º—ã—à–∏
        container.addEventListener('wheel', function(e) {
            e.preventDefault();
            
            const rect = container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const oldZoom = zoom;
            
            if (e.deltaY < 0) {
                // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ
                zoom = Math.min(maxZoom, zoom * 1.1);
            } else {
                // –£–º–µ–Ω—å—à–µ–Ω–∏–µ
                zoom = Math.max(minZoom, zoom * 0.9);
            }
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º—ã—à–∏
            offsetX = mouseX - (mouseX - offsetX) * (zoom / oldZoom);
            offsetY = mouseY - (mouseY - offsetY) * (zoom / oldZoom);
            
            applyTransform();
            draw();
        }, { passive: false });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è
        container.addEventListener('mousedown', function(e) {
            if (e.button === 2) { // –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞
                e.preventDefault();
                isPanning = true;
                panStartX = e.clientX - offsetX;
                panStartY = e.clientY - offsetY;
                container.style.cursor = 'grabbing';
                document.getElementById('panHint').style.display = 'block';
            }
        });
        
        container.addEventListener('mousemove', function(e) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const coords = getCanvasCoordinates(e);
            lastX = coords.x;
            lastY = coords.y;
            updateCoordinatesDisplay(lastX, lastY);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (currentPoints.length > 0 || isCalibrating || testMode) {
                draw();
            }
            
            // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (isPanning) {
                offsetX = e.clientX - panStartX;
                offsetY = e.clientY - panStartY;
                applyTransform();
                draw();
            }
        });
        
        container.addEventListener('mouseup', function(e) {
            if (e.button === 2) {
                isPanning = false;
                container.style.cursor = 'crosshair';
                document.getElementById('panHint').style.display = 'none';
            }
        });
        
        // –ó–∞–ø—Ä–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        container.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
        canvas.addEventListener('click', function(e) {
            const coords = getCanvasCoordinates(e);
            const x = coords.x;
            const y = coords.y;
            
            lastX = x;
            lastY = y;
            updateCoordinatesDisplay(x, y);
            
            if (testMode) {
                drawTestCross(x, y);
                return;
            }
            
            if (isCalibrating) {
                handleCalibrationClick(x, y);
                return;
            }
            
            if (currentTool === 'select') {
                selectObjectAt(x, y);
                return;
            }
            
            if (currentTool === 'measure') {
                currentPoints.push({x, y});
                if (currentPoints.length === 2) {
                    const lengthPx = distance(currentPoints[0], currentPoints[1]);
                    const lengthMeters = lengthPx * scale;
                    
                    measurements.push({
                        x1: currentPoints[0].x, y1: currentPoints[0].y,
                        x2: currentPoints[1].x, y2: currentPoints[1].y,
                        lengthMeters,
                        pixelLength: lengthPx
                    });
                    
                    showStatus(`–ò–∑–º–µ—Ä–µ–Ω–æ: ${lengthMeters.toFixed(2)} –º`, 'success');
                    currentPoints = [];
                }
            } else {
                currentPoints.push({x, y});
                
                if ((currentTool === 'window' || currentTool === 'door') && currentPoints.length >= 2) {
                    completeCurrentObject();
                }
            }
            
            document.getElementById('pointsCount').textContent = `–¢–æ—á–µ–∫: ${currentPoints.length}`;
            draw();
        });
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function updateCoordinatesDisplay(x, y) {
            const metersX = (x * scale).toFixed(2);
            const metersY = (y * scale).toFixed(2);
            
            document.getElementById('coordinates').textContent = 
                `–ü–∏–∫—Å–µ–ª–∏: (${x.toFixed(0)}, ${y.toFixed(0)}) | –ú–µ—Ç—Ä—ã: (${metersX}, ${metersY}) | –ó—É–º: ${Math.round(zoom * 100)}%`;
        }
        
        function distance(p1, p2) {
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            return Math.sqrt(dx*dx + dy*dy);
        }
        
        function getToolName(tool) {
            const names = {
                'wall': '–°—Ç–µ–Ω–∞',
                'window': '–û–∫–Ω–æ', 
                'door': '–î–≤–µ—Ä—å',
                'measure': '–ò–∑–º–µ—Ä–∏—Ç—å',
                'select': '–í—ã–±–æ—Ä'
            };
            return names[tool] || tool;
        }
        
        function selectTool(tool) {
            currentTool = tool;
            
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const toolMap = {
                'wall': '.wall-btn',
                'window': '.window-btn',
                'door': '.door-btn',
                'measure': '.measure-btn',
                'select': '.tool-btn:nth-child(5)'
            };
            
            if (toolMap[tool]) {
                document.querySelector(toolMap[tool]).classList.add('active');
            }
            
            document.getElementById('currentTool').textContent = `–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${getToolName(tool)}`;
            
            if (currentPoints.length > 0 && tool !== 'measure') {
                currentPoints = [];
                document.getElementById('pointsCount').textContent = `–¢–æ—á–µ–∫: 0`;
                draw();
            }
            
            showStatus(`–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${getToolName(tool)}`, 'info');
        }
        
        function completeCurrentObject() {
            if (currentPoints.length < 2) {
                showStatus('–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏', 'warning');
                return;
            }
            
            if (currentTool === 'measure') return;
            
            const obj = {
                type: currentTool,
                points: [...currentPoints],
                id: Date.now() + Math.random(),
                createdAt: new Date().toISOString(),
                segments: []
            };
            
            for (let i = 0; i < obj.points.length - 1; i++) {
                const lengthPx = distance(obj.points[i], obj.points[i + 1]);
                obj.segments.push({
                    lengthPixels: lengthPx,
                    lengthMeters: lengthPx * scale,
                    start: obj.points[i],
                    end: obj.points[i + 1]
                });
            }
            
            obj.totalLengthMeters = obj.segments.reduce((sum, seg) => sum + seg.lengthMeters, 0);
            obj.totalLengthPixels = obj.segments.reduce((sum, seg) => sum + seg.lengthPixels, 0);
            
            markedObjects.push(obj);
            updateObjectsList();
            
            showStatus(`–î–æ–±–∞–≤–ª–µ–Ω ${getToolName(currentTool)}: ${obj.totalLengthMeters.toFixed(2)} –º`, 'success');
            
            currentPoints = [];
            document.getElementById('pointsCount').textContent = `–¢–æ—á–µ–∫: 0`;
            
            draw();
            updateStatistics();
        }
        
        function testCoordinatesMode() {
            testMode = !testMode;
            
            if (testMode) {
                showStatus('–†–µ–∂–∏–º —Ç–µ—Å—Ç–∞: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ. –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —Ç–æ—á–Ω–æ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º.', 'info');
                currentPoints = [];
                isCalibrating = false;
            } else {
                showStatus('–†–µ–∂–∏–º —Ç–µ—Å—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
            }
            
            draw();
        }
        
        function drawTestCross(x, y) {
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - 15, y);
            ctx.lineTo(x + 15, y);
            ctx.moveTo(x, y - 15);
            ctx.lineTo(x, y + 15);
            ctx.stroke();
            
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'red';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(`(${x.toFixed(0)}, ${y.toFixed(0)})`, x + 20, y - 10);
            
            showStatus(`–¢–µ—Å—Ç: –∫–ª–∏–∫ –Ω–∞ (${x.toFixed(0)}, ${y.toFixed(0)})`, 'success');
        }
        
        // ========== –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –†–ê–ó–ú–ï–¢–ö–ò –í –ë–î ==========
        
        function saveMarkup() {
            if (markedObjects.length === 0) {
                showStatus('–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'warning');
                return;
            }
            
            const projectId = document.getElementById('projectId').value;
            const pageNum = document.getElementById('pageNum').value;
            
            const markup = {
                project_id: projectId,
                page_num: parseInt(pageNum),
                scale: scale,
                zoom: zoom,
                offset: { x: offsetX, y: offsetY },
                calibration: {
                    points: calibrationPoints,
                    scale: scale,
                    units: 'meters'
                },
                objects: markedObjects,
                measurements: measurements,
                created_at: new Date().toISOString(),
                total_objects: markedObjects.length,
                version: 'smet4ik-v2.0-fixed-zoom'
            };
            
            try {
                // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem(`smet4ik_markup_${projectId}_${pageNum}`, JSON.stringify(markup));
                
                // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î —á–µ—Ä–µ–∑ API
                showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î...', 'info');
                
                fetch('/api/markup/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(markup)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(`‚úÖ –†–∞–∑–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î (ID: ${data.markup_id})`, 'success');
                        console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î:', data);
                        
                        // 3. –¢–∞–∫–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ JSON —Ñ–∞–π–ª (–∫–∞–∫ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
                        exportToJSON();
                    } else {
                        showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î: ${error.message}`, 'error');
                    // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—Å–µ —Ä–∞–≤–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–∞–π–ª
                    exportToJSON();
                });
                
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }
        
        // ========== –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function updateObjectsList() {
            const list = document.getElementById('objectsList');
            list.innerHTML = '';
            
            markedObjects.forEach((obj, index) => {
                const div = document.createElement('div');
                div.className = `object-item ${obj.type}`;
                
                div.innerHTML = `
                    <div class="object-info">
                        <div>
                            <strong>${getToolName(obj.type)} ${index + 1}</strong><br>
                            <small>${obj.points.length} —Ç–æ—á–µ–∫ | ${obj.totalLengthMeters.toFixed(2)} –º</small>
                        </div>
                        <button class="delete-btn" onclick="deleteObject(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </div>
                `;
                
                list.appendChild(div);
            });
            
            document.getElementById('totalObjects').textContent = markedObjects.length;
        }
        
        function updateStatistics() {
            const walls = markedObjects.filter(obj => obj.type === 'wall');
            const windows = markedObjects.filter(obj => obj.type === 'window');
            const doors = markedObjects.filter(obj => obj.type === 'door');
            
            document.getElementById('wallsCount').textContent = walls.length;
            document.getElementById('windowsCount').textContent = windows.length;
            document.getElementById('doorsCount').textContent = doors.length;
            
            const totalWallsLength = walls.reduce((sum, wall) => sum + wall.totalLengthMeters, 0);
            document.getElementById('totalLength').textContent = totalWallsLength.toFixed(1);
        }
        
        function deleteObject(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç?')) {
                markedObjects.splice(index, 1);
                updateObjectsList();
                draw();
                updateStatistics();
                showStatus('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω', 'info');
            }
        }
        
        function toggleGrid() {
            showGrid = !showGrid;
            draw();
            showStatus(showGrid ? '–°–µ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞' : '–°–µ—Ç–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'info');
        }
        
        function exportToJSON() {
            const projectId = document.getElementById('projectId').value;
            const pageNum = document.getElementById('pageNum').value;
            
            const data = {
                project_id: projectId,
                page_num: parseInt(pageNum),
                scale: scale,
                viewport: {
                    zoom: zoom,
                    offset_x: offsetX,
                    offset_y: offsetY
                },
                image_dimensions: {
                    width_px: canvas.width,
                    height_px: canvas.height
                },
                objects: markedObjects.map(obj => ({
                    type: obj.type,
                    points: obj.points,
                    segments: obj.segments,
                    total_length_m: obj.totalLengthMeters,
                    total_length_px: obj.totalLengthPixels
                })),
                measurements: measurements,
                metadata: {
                    created_at: new Date().toISOString(),
                    total_objects: markedObjects.length,
                    total_walls_length_m: markedObjects
                        .filter(obj => obj.type === 'wall')
                        .reduce((sum, wall) => sum + wall.totalLengthMeters, 0),
                    tool: "Smet4ik AI Trainer v2.0 with fixed zoom"
                }
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `smet4ik_markup_${projectId}_p${pageNum}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showStatus(`–†–∞–∑–º–µ—Ç–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ JSON`, 'success');
        }
        
        function clearAll() {
            if (markedObjects.length === 0 && currentPoints.length === 0 && measurements.length === 0) return;
            
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Ä–∞–∑–º–µ—Ç–∫—É –∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è?')) {
                markedObjects = [];
                currentPoints = [];
                measurements = [];
                selectedObject = null;
                testMode = false;
                
                updateObjectsList();
                draw();
                updateStatistics();
                
                document.getElementById('pointsCount').textContent = `–¢–æ—á–µ–∫: 0`;
                showStatus('–í—Å—è —Ä–∞–∑–º–µ—Ç–∫–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
            }
        }
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            
            const colors = {
                'info': '#2196F3',
                'success': '#4CAF50',
                'warning': '#FF9800',
                'error': '#F44336'
            };
            
            statusEl.style.color = colors[type] || '#333';
        }
        
        function toggleCalibration() {
            isCalibrating = !isCalibrating;
            testMode = false;
            
            const panel = document.getElementById('calibrationPanel');
            
            if (isCalibrating) {
                panel.style.display = 'block';
                calibrationPoints = [];
                document.getElementById('calPoint1').value = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
                document.getElementById('calPoint2').value = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
                document.getElementById('calResult').value = '–û–∂–∏–¥–∞–Ω–∏–µ...';
                showStatus('–†–µ–∂–∏–º –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–∞—á–∞–ª–æ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞', 'info');
            } else {
                panel.style.display = 'none';
                showStatus('–†–µ–∂–∏–º –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
            }
            
            draw();
        }
        
        function cancelCalibration() {
            isCalibrating = false;
            document.getElementById('calibrationPanel').style.display = 'none';
            calibrationPoints = [];
            draw();
            showStatus('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', 'info');
        }
        
        function applyCalibration() {
            if (calibrationPoints.length !== 2) {
                showStatus('–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–≤–µ —Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'warning');
                return;
            }
            
            const realLength = parseFloat(document.getElementById('realLength').value);
            if (!realLength || realLength <= 0) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–ª–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö', 'warning');
                return;
            }
            
            const p1 = calibrationPoints[0];
            const p2 = calibrationPoints[1];
            const pixelLength = distance(p1, p2);
            
            scale = realLength / pixelLength;
            
            document.getElementById('currentScale').value = `1px = ${scale.toFixed(6)}–º`;
            document.getElementById('scaleRatio').textContent = `1 –ø–∏–∫—Å–µ–ª—å = ${scale.toFixed(4)} –º–µ—Ç—Ä–æ–≤`;
            document.getElementById('calResult').value = `–ú–∞—Å—à—Ç–∞–±: 1px = ${scale.toFixed(6)}–º`;
            document.getElementById('calibrationStatus').textContent = `–ú–∞—Å—à—Ç–∞–±: 1:${Math.round(1/scale)}`;
            
            measurements.push({
                x1: p1.x, y1: p1.y,
                x2: p2.x, y2: p2.y,
                lengthMeters: realLength,
                pixelLength: pixelLength,
                scale: scale
            });
            
            showStatus(`–ú–∞—Å—à—Ç–∞–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: 1 –ø–∏–∫—Å–µ–ª—å = ${scale.toFixed(4)} –º–µ—Ç—Ä–æ–≤`, 'success');
            
            recalculateAllObjects();
            
            isCalibrating = false;
            document.getElementById('calibrationPanel').style.display = 'none';
            calibrationPoints = [];
            
            draw();
            updateStatistics();
        }
        
        function autoEstimateScale() {
            const typicalWallLength = 3.5;
            const typicalPixelsForWall = 350;
            
            scale = typicalWallLength / typicalPixelsForWall;
            
            document.getElementById('currentScale').value = `–ê–≤—Ç–æ: 1px ‚âà ${scale.toFixed(6)}–º`;
            document.getElementById('scaleRatio').textContent = `1 –ø–∏–∫—Å–µ–ª—å ‚âà ${scale.toFixed(4)} –º–µ—Ç—Ä–æ–≤`;
            document.getElementById('calibrationStatus').textContent = `–ú–∞—Å—à—Ç–∞–±: –ê–≤—Ç–æ 1:${Math.round(1/scale)}`;
            
            showStatus('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä–Ω—ã–π –º–∞—Å—à—Ç–∞–±. –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.', 'info');
        }
        
        function handleCalibrationClick(x, y) {
            if (calibrationPoints.length < 2) {
                calibrationPoints.push({x: x, y: y});
                
                if (calibrationPoints.length === 1) {
                    document.getElementById('calPoint1').value = `(${x.toFixed(0)}, ${y.toFixed(0)})`;
                    showStatus('–¢–µ–ø–µ—Ä—å –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–æ–Ω–µ—Ü –æ—Ç—Ä–µ–∑–∫–∞ —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º', 'info');
                } else if (calibrationPoints.length === 2) {
                    document.getElementById('calPoint2').value = `(${x.toFixed(0)}, ${y.toFixed(0)})`;
                    
                    const pixelLength = distance(calibrationPoints[0], calibrationPoints[1]);
                    document.getElementById('realLength').value = (pixelLength * 0.01).toFixed(2);
                    
                    showStatus('–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –æ—Ç—Ä–µ–∑–∫–∞ –≤ –º–µ—Ç—Ä–∞—Ö', 'info');
                }
                
                draw();
            }
        }
        
        function recalculateAllObjects() {
            markedObjects.forEach(obj => {
                obj.segments = [];
                for (let i = 0; i < obj.points.length - 1; i++) {
                    const lengthPx = distance(obj.points[i], obj.points[i + 1]);
                    obj.segments.push({
                        lengthPixels: lengthPx,
                        lengthMeters: lengthPx * scale,
                        start: obj.points[i],
                        end: obj.points[i + 1]
                    });
                }
                obj.totalLengthMeters = obj.segments.reduce((sum, seg) => sum + seg.lengthMeters, 0);
                obj.totalLengthPixels = obj.segments.reduce((sum, seg) => sum + seg.lengthPixels, 0);
            });
            
            updateObjectsList();
            updateStatistics();
        }
        
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                completeCurrentObject();
                e.preventDefault();
            } else if (e.key === 'Escape') {
                currentPoints = [];
                testMode = false;
                draw();
                document.getElementById('pointsCount').textContent = `–¢–æ—á–µ–∫: 0`;
                showStatus('–¢–µ–∫—É—â–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', 'info');
            } else if (e.key === 'w' || e.key === '—Ü') {
                selectTool('wall');
            } else if (e.key === 'o' || e.key === '—â') {
                selectTool('window');
            } else if (e.key === 'd' || e.key === '–≤') {
                selectTool('door');
            } else if (e.key === 'm' || e.key === '—å') {
                selectTool('measure');
            } else if (e.key === 't' || e.key === '–µ') {
                testCoordinatesMode();
            } else if (e.key === 's' || e.key === '—ã') {
                selectTool('select');
            } else if (e.key === 'g' || e.key === '–ø') {
                toggleGrid();
            } else if (e.key === 'c' || e.key === '—Å') {
                toggleCalibration();
            } else if (e.key === '+' || e.key === '=') {
                zoomIn();
                e.preventDefault();
            } else if (e.key === '-' || e.key === '_') {
                zoomOut();
                e.preventDefault();
            } else if (e.key === '0' || e.key === 'Home') {
                resetZoom();
            } else if (e.key === 'Delete') {
                if (selectedObject) {
                    const index = markedObjects.indexOf(selectedObject);
                    if (index !== -1) deleteObject(index);
                }
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            selectTool('wall');
            updateStatistics();
            
            const lastProject = localStorage.getItem('smet4ik_last_project');
            if (lastProject) {
                document.getElementById('projectId').value = lastProject;
            }
            
            showStatus('–¢—Ä–µ–Ω–∞–∂–µ—Ä –≥–æ—Ç–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä—Ç–µ–∂. –¢–µ–ø–µ—Ä—å —Ä–∞–∑–º–µ—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î!', 'info');
        }
        
        window.onload = init;
    </script>
</body>
</html>